# 构建自己的TCP协议

## 可靠的概念以及完成的服务

- 基础的数据传输

TCP能够在其用户之间的每个方向传输连续的字节流,将一些字节数据打包成段,通过互联网传输.


- 可靠性

TCP必须从因特网通信系统损坏、丢失、复制或乱序传送的数据中恢复

这是通过给传输的每个字节分配一个序列号,并要求接受的TCP回复一个确认(ACK)来实现的.

如果在规定的时间间隔内没有收到ACK,则重传数据.

在接收方,序列号用来顺序排列可能接收到的乱序的片段,并消除重复的片段.

通过在传输的每个片段上添加一个校验和,在接收方进行检查,并丢弃损坏的片段.

只要TCP各端继续正常运行,网络系统也没有断开,传输错误就不会影响到用户.

- 流量控制

TCP为接收方提供了一种方法来管理发送方发送的数据量,注意这里是接收方可以管理发送方的发送速度

这是通过在每个ACK中返回一个`窗口`来实现的,窗口表示在成功接收的最后一个片段之外的可接受的序列号范围

该窗口表示发送方在接受到进一步确认之前可以传输的字节数量

这里的流量控制实际是为了防止发送方发送过快,接收方无法进行处理设置的....


- 多路复用

在TCP协议中,为了让同一个主机上的多个进程可以同时进行通信,TCP使用了`端口`来区分不同的通信通道,每个进程通过特定的端口进行网络通信

一个套接字由IP地址和端口号组合而成,每个TCP连接都是由一对套接字唯一标识的.

例如192.168.1.1:8080与192.168.1.2:9090这一对套接字就唯一标识了这条TCP连接



- 连接

上述的可靠性和流量控制机制要求TCP初始化和维护每个水流的某些状态信息

这些信息(包括套接字、序列号和窗口大小)的组合称为连接

每个连接都由标识其两端的一对套接字唯一指定

当两个进程想要进行通信的时候,他们必须先建立TCP连接(初始化每一端的状态信息)

当他们的通信完成后,连接被终止或关闭,以释放资源用于其他用途


## 基本原理


进程通过调用TCP并将数据缓冲区作为参数来传输数据

所以我们传递的实际就是个`&buf[u8;1500]`

TCP将这些缓冲区中的数据打包成TCP段,并调用网络模块将每个TCP段传输到目的主机的TCP

接受TCP将TCP段中的数据放入接收用户的缓冲区,并通知接收用户

TCP把控制信息放在TCP段中,他们用于确保可靠有序的数据传输

从概念上讲,每个字节的数据都分配有一个序列号

TCP段中数据的第一个字节的序号是与该TCP段一起传输的序列号,称为segment sequence number

TCP段还携带一个确认号码，这是期望对方传输的下一个字节数据包的序列号

当TCP传输一个TCP段时,它会将TCP段的一个副本放在重传队列中,并启动一个计时器;当收到该数据的确认时,则将TCP段从重传队列中删除

如果在定时器结束之前没有收到确认,则重传该TCP段


## 数据通信

当应用程序调用`SEND`时,数据会被放入TCP的发送缓冲区,发送缓冲区中的数据不会立即发送,而是由TCP协议根据自己的传输策略(如流量控制、拥塞控制)来决定何时发送

应用程序可以通过`PUSH`标志告诉TCP将数据立即发送出去,`PUSH`标志是对TCP的提示,要求TCP不要再等待,必须尽快发送当前所有未发送的数据

TCP协议可以将从应用程序收到的数据进行分片,例如一次`SEND`调用中的数据可能会被拆成多个TCP段发送出去,或者多个`SEND`调用中的数据可以被合并到一个段中

单个TCP段中的数据可以来源于一次完整的`SEND`调用,也可能是一次`SEND`调用的一部分,或者包括多个`SEND`调用的数据



## 头部格式





























- 连接


- 优先级和安全性
